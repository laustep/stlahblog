<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Saturn Elephant - A R graphic in a Yesod app</title>
  <link href="../libraries/bootstrap/bootstrap-grid.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/default2.css" />
  <link rel="stylesheet" href="../css/post.css" />
  <link rel="stylesheet" href="../css/misc.css" /> 
  
    <link rel="stylesheet" href="../css/pandoc-solarized.css" /> 
   
  
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,600,200,800" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Droid+Sans" rel="stylesheet" type="text/css">
  <script src="../libraries/jquery.min.js"></script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar. -->
      <div class="sidebar col-sm-2">
        <div class="row">
          <div class="col-sm-12" style="float:right;clear:both;margin-right:50px;margin-top:50px;">
            <a href="https://www.r-bloggers.com/">
              <img src="../images/Rbloggers.png" alt="Rbloggers" width="100%" />
            </a>
            <br />
            <a href="http://t-redactyl.io/">
              <span style="color:black;font-weight:bold;font-family:sans-serif;font-size:25px;">Standard error</span>
            </a>
            <a href="http://timelyportfolio.blogspot.be/">
              <span style="color:grey;font-weight:bold;font-family:sans-serif;font-size:24px;">Timely portfolio</span>
            </a>
            <br />
            <a href="https://antoineguillot.wordpress.com/blog/">
              <span style="color:white;background-color:darkblue;font-weight:bold;font-family:sans-serif;font-size:21px;border:5px solid;border-color:darkblue">ENHANCE DATA</span>
            </a>
            <br />
            <a href="https://fronkonstin.com/">
              <span style="color:black;background-color:gold;font-weight:bold;font-size:29px;border:3px solid;border-color:gold;">Fronkonstin</span>
            </a>
          </div>
        </div>
        <div id="logos">
          <div class="row">
            <div class="col-sm-4">
              <img src="../images/AsymptoteLogo.svg" style="width: 150%; transform: rotateZ(-35deg)" />
            </div>
            <div class="col-sm-4">
              <img src="../images/Rlogo.svg" style="width: 110%;" />
            </div>
            <div class="col-sm-4">
              <img src="../images/shiny-hex.png" style="width: 90%;" />
            </div>
          </div>
          <div class="row">
            <div class="col-sm-4">
              <img src="../images/Povray_logo_sphere.png" style="width: 105%;" />
            </div>
            <div class="col-sm-4">
              <img src="../images/javascript.svg" style="width: 90%;" />
            </div>
            <div class="col-sm-4">
              <img src="../images/haskell.svg" style="width: 110%;" />
            </div>
          </div>
        </div>
      </div>

      <div class="main col-sm-10">
        <div id="header">
          <div id="logo">
            <a href="../">
              <img src="../images/stla.jpg" alt="stla" width="100px" />
            </a>
          </div>
          <div id="navigation" style="margin-top:50px;">
            <a href="../">Home</a>
            <a href="../about.html">About</a>
            <a href="../contact.html">Contact</a>
            <a href="../archive.html">Archive</a>
          </div>
        </div>

        <div class="content">
          <h1>A R graphic in a Yesod app</h1> 
          <div class="info">
    Posted on December  2, 2023
    
        by Stéphane Laurent
    
</div>
<div class="info">
    
    Tags: <a title="All pages tagged 'R'." href="../tags/R.html">R</a>, <a title="All pages tagged 'haskell'." href="../tags/haskell.html">haskell</a>
    
</div>

<p>Yesod is a web framework for Haskell. In this post I show how to do a Yesod application allowing to upload some data from a CSV or a XLSX file and to display a R graphic representing two selected columns of the data.</p>
<p><img src="./figures/yesod-ggplot.gif" /></p>
<p>Below is the directory content of the application, available in <a href="https://github.com/stla/yesod_ggplot">this Github repository</a>.</p>
<pre><code>|   .dir-locals.el
|   client_session_key.aes
|   package.yaml
|   README.md
|   routes.yesodroutes
|   stack.yaml
|   
+---app
|       Main.hs
|       
+---src
|       Application.hs
|       Foundation.hs
|       GGplot.hs
|       Home.hs
|       
\---static
    +---bootstrap-5.3.2
    |   +---css
    |   |       bootstrap.min.css
    |   |       bootstrap.min.css.map
    |   |       
    |   \---js
    |           bootstrap.bundle.min.js
    |           bootstrap.bundle.min.js.map
    |           
    +---DataTables-1.13.8
    |   |   datatables.min.css
    |   |   datatables.min.js
    |   |   
    |   \---images
    |           sort_asc.png
    |           sort_asc_disabled.png
    |           sort_both.png
    |           sort_desc.png
    |           sort_desc_disabled.png
    |           
    +---images
    |       haskell.png
    |       
    +---jQuery
    |       jquery-3.7.1.min.js
    |       
    +---PapaParse
    |       papaparse.min.js
    |       
    +---R
    |       ggplotXY.R
    |       
    \---SheetJS
            xlsx.core.min.js
            xlsx.core.min.map</code></pre>
<p>I’m using <strong>bootstrap</strong> for the style, <strong>DataTables</strong> to display a nice table of the data, <strong>PapaParse</strong> to parse the uploaded CSV file to a JSON object, and <strong>SheetJS</strong> to convert the uploaded XLSX file to CSV data, which can then be parsed to a JSON object with <strong>PapaParse</strong>.</p>
<p><a href="https://www.yesodweb.com/book/shakespearean-templates">Hamlet</a> is a HTML templating language developed for Yesod applications. Below is the Hamlet code of the application. I use a Bootstrap modal to display errors if there are.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  $# BOOTSTRAP MODAL -----------------------------------------------------------</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  <span class="kw">&lt;div</span><span class="ot"> #myModal</span> <span class="er">.modal</span> <span class="er">.fade</span><span class="ot"> aria-hidden aria-labelledby=</span><span class="st">myModalLabel</span><span class="ot"> tabindex=</span><span class="st">-1</span><span class="kw">&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    <span class="kw">&lt;div</span> <span class="er">.modal-dialog</span> <span class="er">.modal-dialog-centered</span><span class="kw">&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>      <span class="kw">&lt;div</span> <span class="er">.modal-content</span><span class="kw">&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>        <span class="kw">&lt;div</span> <span class="er">.modal-header</span><span class="kw">&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>            <span class="kw">&lt;h1</span> <span class="er">.modal-title</span> <span class="er">.fs-5</span><span class="kw">&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>        <span class="kw">&lt;div</span> <span class="er">.modal-body</span><span class="kw">&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>            <span class="kw">&lt;span</span><span class="ot"> #message</span><span class="kw">&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>        <span class="kw">&lt;div</span> <span class="er">.modal-footer</span><span class="kw">&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>            <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">button</span> <span class="er">.btn</span> <span class="er">.btn-secondary</span><span class="ot"> data-bs-dismiss=</span><span class="st">modal</span><span class="kw">&gt;</span>Close</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  $# HASKELL LOGO --------------------------------------------------------------</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  <span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">./static/images/haskell.png</span><span class="ot"> style=</span><span class="st">float:right;margin:5px;width:50px;</span><span class="kw">&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  $# ---------------------------------------------------------------------------</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>  <span class="kw">&lt;div</span> <span class="er">.container-fluid</span><span class="kw">&gt;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>    $# TABS --------------------------------------------------------</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>    <span class="kw">&lt;ul</span> <span class="er">.nav</span> <span class="er">.nav-tabs</span><span class="ot"> role=</span><span class="st">tablist</span><span class="kw">&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>      <span class="kw">&lt;li</span> <span class="er">.nav-item</span><span class="ot"> role=</span><span class="st">presentation</span><span class="kw">&gt;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>        <span class="kw">&lt;button</span><span class="ot"> #data-tab</span> <span class="er">.nav-link</span> <span class="er">.active</span><span class="ot"> data-bs-toggle=</span><span class="st">tab</span><span class="ot"> data-bs-target=</span><span class="st">#data-tab-pane</span><span class="ot"> type=</span><span class="st">button</span><span class="ot"> role=</span><span class="st">tab</span><span class="ot"> aria-controls=</span><span class="st">data-tab-pane</span><span class="ot"> aria-selected=</span><span class="st">true</span><span class="kw">&gt;</span>Data</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>      <span class="kw">&lt;li</span> <span class="er">.nav-item</span><span class="ot"> role=</span><span class="st">presentation</span><span class="kw">&gt;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>        <span class="kw">&lt;button</span><span class="ot"> #plot-tab</span> <span class="er">.nav-link</span><span class="ot"> data-bs-toggle=</span><span class="st">tab</span><span class="ot"> data-bs-target=</span><span class="st">#plot-tab-pane</span><span class="ot"> type=</span><span class="st">button</span><span class="ot"> role=</span><span class="st">tab</span><span class="ot"> aria-controls=</span><span class="st">plot-tab-pane</span><span class="ot"> aria-selected=</span><span class="st">false</span><span class="kw">&gt;</span>Plot</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>    $# TABS CONTENTS -----------------------------------------------------------</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>    <span class="kw">&lt;div</span><span class="ot"> #tabContent</span> <span class="er">.tab-content</span><span class="kw">&gt;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>      $# DATA TAB --------------------------------------------------------------</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>      <span class="kw">&lt;div</span><span class="ot"> #data-tab-pane</span> <span class="er">.tab-pane</span> <span class="er">.fade</span> <span class="er">.show</span> <span class="er">.active</span><span class="ot"> role=</span><span class="st">tabpanel</span><span class="ot"> aria-labelledby=</span><span class="st">data-tab</span><span class="ot"> tabindex=</span><span class="st">0</span><span class="kw">&gt;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>        <span class="kw">&lt;div</span> <span class="er">.row</span><span class="kw">&gt;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a>          $# SIDEBAR -----------------------------------------------------------</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a>          <span class="kw">&lt;div</span> <span class="er">.col-4</span><span class="kw">&gt;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a>            <span class="kw">&lt;div</span> <span class="er">.card</span> <span class="er">.text-bg-dark</span><span class="ot"> tabindex=</span><span class="st">-1</span><span class="ot"> aria-labelledby=</span><span class="st">sidebarDataTitle</span><span class="kw">&gt;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true"></a>              <span class="kw">&lt;div</span> <span class="er">.card-body</span><span class="kw">&gt;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true"></a>                <span class="kw">&lt;h5</span><span class="ot"> #sidebarDataTitle</span> <span class="er">.card-title</span><span class="kw">&gt;</span>Upload data</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true"></a>                <span class="kw">&lt;h6</span> <span class="er">.card-text</span><span class="kw">&gt;</span>Upload a CSV file or a XLSX file.</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true"></a>                <span class="kw">&lt;p</span> <span class="er">.card-text</span><span class="ot"> style=</span><span class="st">font-style:italic;</span><span class="kw">&gt;</span>If you upload a XLSX file, the data from the first sheet will be extracted.</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true"></a>                <span class="kw">&lt;input</span><span class="ot"> #file type=</span><span class="st">file</span> <span class="er">.form-control</span> <span class="er">.btn</span> <span class="er">.btn-info</span><span class="kw">&gt;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true"></a>          $# TABLE -------------------------------------------------------------</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true"></a>          <span class="kw">&lt;div</span> <span class="er">.col-8</span><span class="kw">&gt;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true"></a>            <span class="kw">&lt;table</span><span class="ot"> #table</span> <span class="er">.table-striped</span> <span class="er">.table-bordered</span> <span class="er">.table-hover</span><span class="kw">&gt;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true"></a>              <span class="kw">&lt;thead&gt;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true"></a>                <span class="kw">&lt;tr</span><span class="ot"> role=</span><span class="st">row</span><span class="kw">&gt;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true"></a>              <span class="kw">&lt;tbody&gt;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true"></a>      $# PLOT TAB --------------------------------------------------------------</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true"></a>      <span class="kw">&lt;div</span><span class="ot"> #plot-tab-pane</span> <span class="er">.tab-pane</span> <span class="er">.fade</span><span class="ot"> role=</span><span class="st">tabpanel</span><span class="ot"> aria-labelledby=</span><span class="st">plot-tab</span><span class="ot"> tabindex=</span><span class="st">0</span><span class="kw">&gt;</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true"></a>        <span class="kw">&lt;div</span> <span class="er">.row</span><span class="kw">&gt;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true"></a>          $# SIDEBAR -----------------------------------------------------------</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true"></a>          <span class="kw">&lt;div</span> <span class="er">.col-4</span><span class="kw">&gt;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true"></a>            <span class="kw">&lt;div</span> <span class="er">.sidebar</span> <span class="er">.card</span> <span class="er">.text-bg-dark</span><span class="ot"> tabindex=</span><span class="st">-1</span><span class="ot"> aria-labelledby=</span><span class="st">sidebarPlotTitle</span><span class="kw">&gt;</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true"></a>              <span class="kw">&lt;div</span> <span class="er">.card-body</span><span class="kw">&gt;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true"></a>                <span class="kw">&lt;div</span> <span class="er">.sidebar-header</span><span class="kw">&gt;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true"></a>                  <span class="kw">&lt;h5</span><span class="ot"> #sidebarPlotTitle</span> <span class="er">.card-title</span><span class="kw">&gt;</span>Plot</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true"></a>                <span class="kw">&lt;div</span> <span class="er">.sidebar-body</span><span class="kw">&gt;</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true"></a>                  <span class="kw">&lt;fieldset</span><span class="ot"> #selectXY style=</span><span class="st">display:none;</span><span class="kw">&gt;</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true"></a>                    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">selX</span><span class="kw">&gt;</span>Select the <span class="kw">&lt;em&gt;</span>x<span class="kw">&lt;/em&gt;</span> column</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true"></a>                    <span class="kw">&lt;select</span> <span class="er">.form-control</span><span class="ot"> #selX style=</span><span class="st">overflow-y:auto;</span><span class="kw">&gt;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true"></a>                    <span class="kw">&lt;br&gt;</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true"></a>                    <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">selY</span><span class="kw">&gt;</span>Select the <span class="kw">&lt;em&gt;</span>y<span class="kw">&lt;/em&gt;</span> column</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true"></a>                    <span class="kw">&lt;select</span> <span class="er">.form-control</span><span class="ot"> #selY style=</span><span class="st">overflow-y:auto;</span><span class="kw">&gt;</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true"></a>            $# SPINNER ---------------------------------------------------------</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true"></a>            <span class="kw">&lt;div</span><span class="ot"> #spinner</span> <span class="er">.spinner-border</span> <span class="er">.m-5</span><span class="ot"> role=</span><span class="st">status</span><span class="ot"> style=</span><span class="st">display:none</span><span class="kw">&gt;</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true"></a>                <span class="kw">&lt;span</span> <span class="er">.visually-hidden</span><span class="kw">&gt;</span>Loading...</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true"></a>          $# PLOT --------------------------------------------------------------</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true"></a>          <span class="kw">&lt;div</span> <span class="er">.col-8</span><span class="kw">&gt;</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true"></a>            <span class="kw">&lt;img</span><span class="ot"> #plot width=</span><span class="st">100%</span><span class="ot"> height=</span><span class="st">400px</span><span class="kw">&gt;</span></span></code></pre></div>
<p>The interface has two tabs: one to upload and display the data, and the other one to select two columns and display the graphic.</p>
<p>The JavaScript function below will be called when the user uploads a file. The file can be either a CSV file or a XLSX file. If this is a XLSX file, then its content will be converted to CSV data before calling this function. This function firstly converts the CSV data to a JSON object, then it fills the table with the data and the <code>x</code> and <code>y</code> dropdown lists with the column names, and then it defines the behavior of the application.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">function</span> <span class="fu">papaParse</span>(csv) {</span>
<span id="cb3-2"><a href="#cb3-2"></a>  Papa<span class="op">.</span><span class="fu">parse</span>(csv<span class="op">,</span> {</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">header</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="dt">skipEmptyLines</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="dt">dynamicTyping</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="dt">complete</span><span class="op">:</span> <span class="kw">function</span>(results) {</span>
<span id="cb3-7"><a href="#cb3-7"></a>      <span class="cf">if</span>(results<span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">length</span> <span class="op">!=</span> <span class="dv">0</span>) {</span>
<span id="cb3-8"><a href="#cb3-8"></a>        <span class="fu">alert</span>(<span class="st">&quot;Something is wrong with this CSV file.&quot;</span>)<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Errors:&quot;</span><span class="op">,</span> results<span class="op">.</span><span class="at">errors</span>)<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&quot;Something is wrong with this CSV file.&quot;</span>)<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>      }</span>
<span id="cb3-12"><a href="#cb3-12"></a>      <span class="kw">let</span> dataframe <span class="op">=</span> results<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>      <span class="kw">let</span> colNames <span class="op">=</span> results<span class="op">.</span><span class="at">meta</span><span class="op">.</span><span class="at">fields</span><span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>      <span class="co">// Fill the table --------------------------------------------------------</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>      <span class="kw">let</span> headers <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>      <span class="cf">for</span>(<span class="kw">let</span> colname <span class="kw">of</span> colNames) {</span>
<span id="cb3-17"><a href="#cb3-17"></a>        headers <span class="op">+=</span> <span class="st">&quot;&lt;th&gt;&quot;</span> <span class="op">+</span> colname <span class="op">+</span> <span class="st">&quot;&lt;/th&gt;&quot;</span><span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>      }</span>
<span id="cb3-19"><a href="#cb3-19"></a>      <span class="fu">$</span>(<span class="st">&quot;#table thead tr&quot;</span>)<span class="op">.</span><span class="fu">append</span>(headers)<span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>      <span class="kw">let</span> columns <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>      <span class="cf">for</span>(<span class="kw">let</span> colname <span class="kw">of</span> colNames) {</span>
<span id="cb3-22"><a href="#cb3-22"></a>        columns<span class="op">.</span><span class="fu">push</span>({ <span class="dt">data</span><span class="op">:</span> colname })<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>      }</span>
<span id="cb3-24"><a href="#cb3-24"></a>      <span class="fu">$</span>(<span class="st">&quot;#table&quot;</span>)<span class="op">.</span><span class="fu">DataTable</span>({</span>
<span id="cb3-25"><a href="#cb3-25"></a>        <span class="dt">data</span><span class="op">:</span> results<span class="op">.</span><span class="at">data</span><span class="op">,</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>        <span class="dt">columns</span><span class="op">:</span> columns</span>
<span id="cb3-27"><a href="#cb3-27"></a>      })<span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28"></a>      <span class="co">// the dataframe is an array of objects like:</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>      <span class="co">//   [{A: a1, B: b1, ...}, {A: a2, B: b2, ...}, ...]</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>      <span class="co">// we transform it to this object:</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>      <span class="co">//   {A: [a1, a2, ...], B: [b1, b2, ...], ...}</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>      <span class="kw">let</span> dfx <span class="op">=</span> {}<span class="op">;</span> <span class="co">// for x, we convert every entry to a string</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>      <span class="kw">let</span> dfy <span class="op">=</span> {}<span class="op">;</span> <span class="co">// for y, we don't convert anything</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>      <span class="cf">for</span>(<span class="kw">let</span> colname <span class="kw">of</span> colNames) {</span>
<span id="cb3-35"><a href="#cb3-35"></a>        <span class="kw">let</span> columnx <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>        <span class="kw">let</span> columny <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>        <span class="cf">for</span>(<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> dataframe<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb3-38"><a href="#cb3-38"></a>          <span class="kw">let</span> entry <span class="op">=</span> dataframe[j][colname]<span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>          columnx<span class="op">.</span><span class="fu">push</span>(entry<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>          columny<span class="op">.</span><span class="fu">push</span>(entry)<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>        }</span>
<span id="cb3-42"><a href="#cb3-42"></a>        dfx[colname] <span class="op">=</span> columnx<span class="op">;</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>        dfy[colname] <span class="op">=</span> columny<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>      }</span>
<span id="cb3-45"><a href="#cb3-45"></a>      <span class="co">// Fill the x &amp; y dropdowns ----------------------------------------------</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>      <span class="kw">let</span> $selsXY <span class="op">=</span> <span class="fu">$</span>(<span class="st">&quot;#selX, #selY&quot;</span>)<span class="op">;</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>      <span class="kw">let</span> ncolumns <span class="op">=</span> colNames<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>      <span class="kw">let</span> size <span class="op">=</span> ncolumns <span class="op">&lt;</span> <span class="dv">5</span> <span class="op">?</span> ncolumns <span class="op">:</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>      $selsXY<span class="op">.</span><span class="fu">attr</span>(<span class="st">&quot;size&quot;</span><span class="op">,</span> size)<span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>      <span class="fu">$</span>(colNames)<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(idx<span class="op">,</span> item) {</span>
<span id="cb3-51"><a href="#cb3-51"></a>        <span class="cf">if</span>(item <span class="op">!=</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb3-52"><a href="#cb3-52"></a>          $selsXY<span class="op">.</span><span class="fu">append</span>(<span class="fu">$</span>(<span class="st">&quot;&lt;option&gt;&quot;</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">&quot;value&quot;</span><span class="op">,</span> idx)<span class="op">.</span><span class="fu">text</span>(item))<span class="op">;</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>        }</span>
<span id="cb3-54"><a href="#cb3-54"></a>      })<span class="op">;</span></span>
<span id="cb3-55"><a href="#cb3-55"></a>      <span class="co">// Set x to the first column and y to the second one ---------------------</span></span>
<span id="cb3-56"><a href="#cb3-56"></a>      <span class="kw">let</span> selX <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#selX&quot;</span>)<span class="op">;</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>      <span class="kw">let</span> selY <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#selY&quot;</span>)<span class="op">;</span></span>
<span id="cb3-58"><a href="#cb3-58"></a>      selX<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&quot;0&quot;</span><span class="op">;</span></span>
<span id="cb3-59"><a href="#cb3-59"></a>      selY<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&quot;1&quot;</span><span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>      <span class="fu">$</span>(<span class="st">&quot;#selectXY&quot;</span>)<span class="op">.</span><span class="fu">show</span>()<span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>      <span class="co">// Initial plot ----------------------------------------------------------</span></span>
<span id="cb3-62"><a href="#cb3-62"></a>      <span class="kw">let</span> myModalEl <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;myModal&quot;</span>)<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>      <span class="kw">let</span> myModal <span class="op">=</span> <span class="kw">new</span> bootstrap<span class="op">.</span><span class="fu">Modal</span>(myModalEl)<span class="op">;</span></span>
<span id="cb3-64"><a href="#cb3-64"></a>      <span class="kw">let</span> messageEl <span class="op">=</span> myModalEl<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;#message&quot;</span>)<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65"></a>      <span class="kw">let</span> titleEl <span class="op">=</span> myModalEl<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&quot;.modal-title&quot;</span>)<span class="op">;</span></span>
<span id="cb3-66"><a href="#cb3-66"></a>      <span class="kw">let</span> $selX <span class="op">=</span> <span class="fu">$</span>(<span class="st">&quot;#selX&quot;</span>)<span class="op">;</span></span>
<span id="cb3-67"><a href="#cb3-67"></a>      <span class="kw">let</span> $selY <span class="op">=</span> <span class="fu">$</span>(<span class="st">&quot;#selY&quot;</span>)<span class="op">;</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>      <span class="fu">plot</span>($selX<span class="op">,</span> $selY<span class="op">,</span> dfx<span class="op">,</span> dfy<span class="op">,</span> colNames<span class="op">,</span> titleEl<span class="op">,</span> messageEl<span class="op">,</span> myModal)<span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69"></a>      <span class="co">// Plot on change x or y -------------------------------------------------</span></span>
<span id="cb3-70"><a href="#cb3-70"></a>      $selsXY<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;change&quot;</span><span class="op">,</span> <span class="kw">function</span>() {</span>
<span id="cb3-71"><a href="#cb3-71"></a>        <span class="fu">plot</span>($selX<span class="op">,</span> $selY<span class="op">,</span> dfx<span class="op">,</span> dfy<span class="op">,</span> colNames<span class="op">,</span> titleEl<span class="op">,</span> messageEl<span class="op">,</span> myModal)<span class="op">;</span></span>
<span id="cb3-72"><a href="#cb3-72"></a>      })<span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73"></a>      <span class="co">// Plot on resize --------------------------------------------------------</span></span>
<span id="cb3-74"><a href="#cb3-74"></a>      <span class="fu">$</span>(<span class="bu">window</span>)<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;resize&quot;</span><span class="op">,</span> <span class="kw">function</span>() {</span>
<span id="cb3-75"><a href="#cb3-75"></a>        <span class="fu">plot</span>($selX<span class="op">,</span> $selY<span class="op">,</span> dfx<span class="op">,</span> dfy<span class="op">,</span> colNames<span class="op">,</span> titleEl<span class="op">,</span> messageEl<span class="op">,</span> myModal)<span class="op">;</span></span>
<span id="cb3-76"><a href="#cb3-76"></a>      })<span class="op">;</span></span>
<span id="cb3-77"><a href="#cb3-77"></a>    }</span>
<span id="cb3-78"><a href="#cb3-78"></a>  })<span class="op">;</span></span>
<span id="cb3-79"><a href="#cb3-79"></a>}</span></code></pre></div>
<p>Here is the JavaScript code handling the file upload:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">$</span>(<span class="kw">function</span>() {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">$</span>(<span class="st">&quot;#file&quot;</span>)<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;change&quot;</span><span class="op">,</span> <span class="kw">function</span>(e) {</span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="kw">let</span> file <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="kw">let</span> extension <span class="op">=</span> file<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&quot;.&quot;</span>)<span class="op">.</span><span class="fu">pop</span>()<span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="co">// --------------------------------------------------------------------</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="cf">if</span>(extension <span class="op">===</span> <span class="st">&quot;xlsx&quot;</span>) {</span>
<span id="cb4-7"><a href="#cb4-7"></a>      <span class="kw">let</span> reader <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileReader</span>()<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>      reader<span class="op">.</span><span class="at">onload</span> <span class="op">=</span> <span class="kw">function</span> (e) {</span>
<span id="cb4-9"><a href="#cb4-9"></a>        <span class="kw">let</span> workbook<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>        <span class="cf">try</span> {</span>
<span id="cb4-11"><a href="#cb4-11"></a>          workbook <span class="op">=</span> XLSX<span class="op">.</span><span class="fu">read</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">result</span><span class="op">,</span> {</span>
<span id="cb4-12"><a href="#cb4-12"></a>            <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;binary&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>          })<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>        } <span class="cf">catch</span>(err) {</span>
<span id="cb4-15"><a href="#cb4-15"></a>          <span class="fu">alert</span>(<span class="st">&quot;Something is wrong with this XLSX file.&quot;</span>)<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>          <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(err)<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>        }</span>
<span id="cb4-18"><a href="#cb4-18"></a>        <span class="kw">let</span> sheetNames <span class="op">=</span> workbook<span class="op">.</span><span class="at">SheetNames</span><span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>        <span class="kw">let</span> sheet1 <span class="op">=</span> sheetNames[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>        <span class="kw">let</span> XLSXasCSV <span class="op">=</span> XLSX<span class="op">.</span><span class="at">utils</span><span class="op">.</span><span class="fu">sheet_to_csv</span>(workbook<span class="op">.</span><span class="at">Sheets</span>[sheet1])<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="fu">papaParse</span>(XLSXasCSV)<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>      }<span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>      reader<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> <span class="kw">function</span>(err) {</span>
<span id="cb4-24"><a href="#cb4-24"></a>        <span class="fu">alert</span>(<span class="st">&quot;I can't read this XLSX file!&quot;</span>)<span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(err)<span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>      }<span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>      reader<span class="op">.</span><span class="fu">readAsArrayBuffer</span>(file)<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>    } <span class="cf">else</span> <span class="cf">if</span>(extension <span class="op">===</span> <span class="st">&quot;csv&quot;</span> <span class="op">||</span> extension <span class="op">===</span> <span class="st">&quot;tsv&quot;</span>) {</span>
<span id="cb4-29"><a href="#cb4-29"></a>      <span class="fu">papaParse</span>(file)<span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>    }</span>
<span id="cb4-31"><a href="#cb4-31"></a>  })<span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>})<span class="op">;</span></span></code></pre></div>
<p>Below is the <code>plot</code> function. It firstly collects the data of the two selected columns and the dimensions of the plot container, and then with an Ajax PUT request, it sends all these data to Haskell. The Haskell function <code>putGgplotR</code> will receive these data, it will send them to R and it will get the result from R. This result is either a base64 string coding the graphic or an error message. We use a separator <code>"*::*::*::*::*"</code> to put the error message at the left of it and the base64 string at the right of it. If there’s no error then the left part is the empty string. The Ajax request receives this result. If there is an error message then it includes it in the Bootstrap modal and displays this modal. If there is no error message then it sends the base64 string to the <code>img</code> element of the interface.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">function</span> <span class="fu">plot</span>($selX<span class="op">,</span> $selY<span class="op">,</span> dfx<span class="op">,</span> dfy<span class="op">,</span> colNames<span class="op">,</span> titleEl<span class="op">,</span> messageEl<span class="op">,</span> myModal) {</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">$</span>(<span class="st">&quot;#spinner&quot;</span>)<span class="op">.</span><span class="fu">show</span>()<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="kw">let</span> xidx <span class="op">=</span> $selX<span class="op">.</span><span class="fu">val</span>()<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="kw">let</span> yidx <span class="op">=</span> $selY<span class="op">.</span><span class="fu">val</span>()<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="kw">let</span> x <span class="op">=</span> dfx[colNames[xidx]]<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="kw">let</span> y <span class="op">=</span> dfy[colNames[yidx]]<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="kw">let</span> width <span class="op">=</span> <span class="fu">$</span>(<span class="st">&quot;#plot&quot;</span>)<span class="op">.</span><span class="fu">width</span>()<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="cf">if</span>(width <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="co">// the plot tab is initially hidden and then width=0</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>    width <span class="op">=</span> <span class="dv">770</span><span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  }</span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="kw">let</span> height <span class="op">=</span> <span class="fu">$</span>(<span class="st">&quot;#plot&quot;</span>)<span class="op">.</span><span class="fu">height</span>()<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="cf">if</span>(height <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb5-14"><a href="#cb5-14"></a>    height <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>  }</span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="kw">let</span> XYwh <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">_x</span><span class="op">:</span> x<span class="op">,</span> <span class="dt">_y</span><span class="op">:</span> y<span class="op">,</span> <span class="dt">_width</span><span class="op">:</span> width<span class="op">,</span> <span class="dt">_height</span><span class="op">:</span> height })<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>  <span class="kw">let</span> JSONstring <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(XYwh)<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>  $<span class="op">.</span><span class="fu">ajax</span>({</span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="dt">contentType</span><span class="op">:</span> <span class="st">&quot;application/json; charset=UTF-8&quot;</span><span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>    <span class="dt">processData</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>    <span class="dt">url</span><span class="op">:</span> <span class="st">&quot;@{GgplotR}&quot;</span><span class="op">,</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;PUT&quot;</span><span class="op">,</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>    <span class="dt">data</span><span class="op">:</span> JSONstring<span class="op">,</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>    <span class="dt">success</span><span class="op">:</span> <span class="kw">function</span>(string) {</span>
<span id="cb5-25"><a href="#cb5-25"></a>      <span class="fu">$</span>(<span class="st">&quot;#spinner&quot;</span>)<span class="op">.</span><span class="fu">hide</span>()<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>      <span class="kw">let</span> error_base64 <span class="op">=</span> string<span class="op">.</span><span class="fu">split</span>(<span class="st">&quot;*::*::*::*::*&quot;</span>)<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>      <span class="kw">let</span> error <span class="op">=</span> error_base64[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>      <span class="cf">if</span>(error <span class="op">===</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb5-29"><a href="#cb5-29"></a>        <span class="kw">let</span> base64 <span class="op">=</span> error_base64[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>        <span class="fu">$</span>(<span class="st">&quot;#plot&quot;</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">&quot;src&quot;</span><span class="op">,</span> base64)<span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-32"><a href="#cb5-32"></a>        titleEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&quot;An error has occured&quot;</span><span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>        messageEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> error<span class="op">;</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>        myModal<span class="op">.</span><span class="fu">show</span>()<span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>      }</span>
<span id="cb5-36"><a href="#cb5-36"></a>    }<span class="op">,</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>    <span class="dt">dataType</span><span class="op">:</span> <span class="st">&quot;text&quot;</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>  })<span class="op">;</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>}</span></code></pre></div>
<p>The Haskell function <code>putGgplotR</code> that we just mentioned will send the data to R with a JSON file written in the temporary folder. Here is the function used to write a temporary file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ot">writeTempFile ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>writeTempFile contents fileName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    tmpDir <span class="ot">&lt;-</span> getCanonicalTemporaryDirectory</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    dir <span class="ot">&lt;-</span> createTempDirectory tmpDir <span class="st">&quot;yesod&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    <span class="kw">let</span> filePath <span class="ot">=</span> dir <span class="op">++</span> <span class="st">&quot;/&quot;</span> <span class="op">++</span> fileName</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="fu">writeFile</span> filePath contents</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    <span class="fu">return</span> <span class="op">$</span> replaceBackslahes filePath</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    <span class="kw">where</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a><span class="ot">        replaceBackslahes ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        replaceBackslahes string <span class="ot">=</span> subRegex (mkRegex <span class="st">&quot;\\\\&quot;</span>) string <span class="st">&quot;/&quot;</span></span></code></pre></div>
<p>And here is the function <code>putGgplotR</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ot">putGgplotR ::</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>putGgplotR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    jsonData <span class="ot">&lt;- requireCheckJsonBody ::</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>    jsonFile <span class="ot">&lt;-</span> liftIO <span class="op">$</span> writeTempFile jsonData <span class="st">&quot;data.json&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>    (exitcode, stdout, stderr) <span class="ot">&lt;-</span> liftIO <span class="op">$</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>        readProcessWithExitCode <span class="st">&quot;Rscript&quot;</span> [<span class="st">&quot;-e&quot;</span>, rCommand jsonFile] <span class="st">&quot;&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    <span class="kw">let</span> base64 <span class="ot">=</span> stdout</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    <span class="kw">let</span> err <span class="ot">=</span> <span class="kw">if</span> exitcode <span class="op">==</span> <span class="dt">ExitSuccess</span> <span class="kw">then</span> <span class="st">&quot;&quot;</span> <span class="kw">else</span> stderr</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    <span class="co">-- return the error message and the base64 string with a separator</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>    <span class="fu">return</span> <span class="op">$</span> err <span class="op">++</span> <span class="st">&quot;*::*::*::*::*&quot;</span> <span class="op">++</span> base64</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>    <span class="kw">where</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a><span class="ot">        rCommand ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>        rCommand file <span class="ot">=</span> </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>            <span class="st">&quot;jsonFile&lt;-&quot;</span> <span class="op">++</span> quote file <span class="op">++</span> </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>                <span class="st">&quot;;source(&quot;</span> <span class="op">++</span> quote <span class="st">&quot;static/R/ggplotXY.R&quot;</span> <span class="op">++</span> <span class="st">&quot;)&quot;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>            <span class="kw">where</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a><span class="ot">                quote ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a>                quote x <span class="ot">=</span> <span class="st">&quot;\&quot;&quot;</span> <span class="op">++</span> x <span class="op">++</span> <span class="st">&quot;\&quot;&quot;</span>        </span></code></pre></div>
<p>Finally, here is the R file <strong><em>ggplotXY.R</em></strong> which is sourced:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r numberLines"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">library</span>(jsonlite)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">library</span>(base64enc)</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co"># extract data from the JSON file</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>jsonData &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(jsonFile)</span>
<span id="cb8-7"><a href="#cb8-7"></a>x &lt;-<span class="st"> </span>jsonData[[<span class="st">&quot;_x&quot;</span>]]</span>
<span id="cb8-8"><a href="#cb8-8"></a>y &lt;-<span class="st"> </span>jsonData[[<span class="st">&quot;_y&quot;</span>]]</span>
<span id="cb8-9"><a href="#cb8-9"></a>w &lt;-<span class="st"> </span>jsonData[[<span class="st">&quot;_width&quot;</span>]]</span>
<span id="cb8-10"><a href="#cb8-10"></a>h &lt;-<span class="st"> </span>jsonData[[<span class="st">&quot;_height&quot;</span>]]</span>
<span id="cb8-11"><a href="#cb8-11"></a></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co"># if `y` is not numeric, we throw an error</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">is.numeric</span>(y)) {</span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="kw">stop</span>(<span class="st">&quot;The `y` column is not numeric.&quot;</span>)</span>
<span id="cb8-15"><a href="#cb8-15"></a>}</span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co"># function to convert x to numeric if possible</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>maybeNumeric &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb8-19"><a href="#cb8-19"></a>  xx &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(x)</span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="cf">if</span>(<span class="kw">anyNA</span>(xx)) x <span class="cf">else</span> xx</span>
<span id="cb8-21"><a href="#cb8-21"></a>}</span>
<span id="cb8-22"><a href="#cb8-22"></a></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="co"># data</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">maybeNumeric</span>(x), <span class="dt">y =</span> y)</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co"># plot</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(dat, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="st">  </span><span class="kw">geom_point</span>()</span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="co"># save plot as PNG</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>png &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.png&quot;</span>)</span>
<span id="cb8-32"><a href="#cb8-32"></a><span class="kw">ggsave</span>(png, gg, <span class="dt">width =</span> w, <span class="dt">height =</span> h, <span class="dt">units =</span> <span class="st">&quot;px&quot;</span>, <span class="dt">dpi =</span> <span class="st">&quot;print&quot;</span>)</span>
<span id="cb8-33"><a href="#cb8-33"></a></span>
<span id="cb8-34"><a href="#cb8-34"></a><span class="co"># convert the PNG file to a base64 string</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>base64 &lt;-<span class="st"> </span><span class="kw">dataURI</span>(<span class="dt">file =</span> png, <span class="dt">mime =</span> <span class="st">&quot;image/png&quot;</span>)</span>
<span id="cb8-36"><a href="#cb8-36"></a></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="co"># print the base64 string</span></span>
<span id="cb8-38"><a href="#cb8-38"></a><span class="kw">cat</span>(base64)</span></code></pre></div>

        </div>


        <div id="footer">
          Site proudly generated by
          <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

      </div>

    </div>

    <div class="row">
      <div class="col-sm-12">
        <div id="disqus_thread"></div>
        <div class="pagination">
          <ul>
            <li>
              <a href="http://laustep.github.io/stlahblog/">« Back Home</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    
  </div>

</body>

<script src="../libraries/bootstrap/bootstrap.min.js"></script>
<script>
  var disqus_developer = 1;
  var disqus_shortname = 'stlapblog';
  // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] ||
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<!-- MathJax: Fall back to local if CDN offline but local image fonts are not supported (saves >100MB) -->
<script type="text/x-mathjax-config" src="../libraries/mathjax/config/TeX-MML-AM_CHTML.js"></script>
<!-- <script>
  window.MathJax || document.write('<script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS":{imageFont:null}});<\/script><script src="../libraries/mathjax/MathJax.js"><\/script>');
</script> -->


</html>