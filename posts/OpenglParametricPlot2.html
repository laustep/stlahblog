<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Saturn Elephant - Parametric surface in Haskell OpenGL, with surface normals</title>
  <link href="../libraries/bootstrap/bootstrap-grid.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/post.css" />
  <link rel="stylesheet" href="../css/misc.css" /> 
  
    <link rel="stylesheet" href="../css/kate.css" /> 
   
  
    <link href="../libraries/highlighters/prettify/css/twitter-bootstrap.css" rel="stylesheet"> 
  
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,600,200,800" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Droid+Sans" rel="stylesheet" type="text/css">
  <script src="../libraries/jquery.min.js"></script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar. -->
      <div class="sidebar col-sm-3">
        <div style="float:right;clear:both;margin-right:50px;margin-top:150px;">
          <a href="https://www.r-bloggers.com/">
            <img src="https://www.r-bloggers.com/wp-content/uploads/2016/04/R_02_2016-05-01.png" alt="stla" width="100%" />
          </a>
          <br />
          <a href="http://t-redactyl.io/">
            <span style="color:black;font-weight:bold;font-family:sans-serif;font-size:29px;">Standard error</span>
          </a>
          <a href="http://timelyportfolio.blogspot.be/">
            <span style="color:grey;font-weight:bold;font-family:sans-serif;font-size:27px;">Timely portfolio</span>
          </a>
          <br />
          <a href="https://antoineguillot.wordpress.com/blog/">
            <span style="color:white;background-color:darkblue;font-weight:bold;font-family:sans-serif;font-size:25px;border:5px solid;border-color:darkblue">ENHANCE DATA</span>
          </a>
          <br />
          <a href="https://fronkonstin.com/">
            <span style="color:black;background-color:gold;font-weight:bold;font-size:32px;border:3px solid;border-color:gold;">Fronkonstin</span>
          </a>
        </div>
      </div>

      <div class="main col-sm-9">
        <div id="header">
          <div id="logo" style="position:absolute;">
            <a href="../">
              <img src="../images/stla.jpg" alt="stla" width="100px" />
            </a>
          </div>
          <div id="navigation" style="margin-top:50px;">
            <a href="../">Home</a>
            <a href="../about.html">About</a>
            <a href="../contact.html">Contact</a>
            <a href="../archive.html">Archive</a>
          </div>
        </div>

        <div class="content">
          <h1>Parametric surface in Haskell OpenGL, with surface normals</h1> 
          <div class="info">
    Posted on October 23, 2018
    
        by Stéphane Laurent
    
</div>
<div class="info">
    
    Tags: <a href="../tags/haskell.html">haskell</a>, <a href="../tags/graphics.html">graphics</a>, <a href="../tags/opengl.html">opengl</a>
    
</div>

<p>Similarly to <a href="https://laustep.github.io/stlahblog/posts/OpenglParametricPlot.html">a previous post</a>, I will show here how to draw a parametric surface with the Haskell OpenGL library, but this time we will include the surface normal at each vertex.</p>
<p>As the example of a surface, I take the stereographic projection of a Hopf torus. The parameterization is given by the function defined as follows in Haskell:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">type</span> <span class="dt">Point</span> <span class="ot">=</span> (<span class="dt">Double</span>, <span class="dt">Double</span>, <span class="dt">Double</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">hopf ::</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Point</span></a>
<a class="sourceLine" id="cb1-4" title="4">hopf v <span class="ot">=</span> (x1<span class="op">/</span>(den<span class="op">-</span>x4), x2<span class="op">/</span>(den<span class="op">-</span>x4), x3<span class="op">/</span>(den<span class="op">-</span>x4))</a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-6" title="6">    a <span class="ot">=</span> <span class="fl">0.44</span></a>
<a class="sourceLine" id="cb1-7" title="7">    nlobes <span class="ot">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb1-8" title="8">    a1 <span class="ot">=</span> <span class="fu">pi</span><span class="op">/</span><span class="dv">2</span> <span class="op">-</span> (<span class="fu">pi</span><span class="op">/</span><span class="dv">2</span><span class="op">-</span>a) <span class="op">*</span> <span class="fu">cos</span>(u<span class="op">*</span>nlobes)</a>
<a class="sourceLine" id="cb1-9" title="9">    a2 <span class="ot">=</span> u <span class="op">+</span> a<span class="op">*</span><span class="fu">sin</span>(<span class="dv">2</span><span class="op">*</span>u<span class="op">*</span>nlobes)</a>
<a class="sourceLine" id="cb1-10" title="10">    sina1 <span class="ot">=</span> <span class="fu">sin</span> a1</a>
<a class="sourceLine" id="cb1-11" title="11">    p1 <span class="ot">=</span> <span class="fu">cos</span> a1</a>
<a class="sourceLine" id="cb1-12" title="12">    p2 <span class="ot">=</span> sina1 <span class="op">*</span> <span class="fu">cos</span> a2</a>
<a class="sourceLine" id="cb1-13" title="13">    p3 <span class="ot">=</span> sina1 <span class="op">*</span> <span class="fu">sin</span> a2</a>
<a class="sourceLine" id="cb1-14" title="14">    cosphi <span class="ot">=</span> <span class="fu">cos</span> v</a>
<a class="sourceLine" id="cb1-15" title="15">    sinphi <span class="ot">=</span> <span class="fu">sin</span> v</a>
<a class="sourceLine" id="cb1-16" title="16">    x1 <span class="ot">=</span> cosphi<span class="op">*</span>p3 <span class="op">+</span> sinphi<span class="op">*</span>p2</a>
<a class="sourceLine" id="cb1-17" title="17">    x2 <span class="ot">=</span> cosphi<span class="op">*</span>p2 <span class="op">-</span> sinphi<span class="op">*</span>p3</a>
<a class="sourceLine" id="cb1-18" title="18">    x3 <span class="ot">=</span> sinphi <span class="op">*</span> (<span class="dv">1</span><span class="op">+</span>p1)</a>
<a class="sourceLine" id="cb1-19" title="19">    x4 <span class="ot">=</span> cosphi <span class="op">*</span> (<span class="dv">1</span><span class="op">+</span>p1)</a>
<a class="sourceLine" id="cb1-20" title="20">    den <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">2</span><span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>p1))</a></code></pre></div>
<p>for <span class="math inline">\(0 \leq u &lt; 2\pi\)</span> and <span class="math inline">\(0 \leq v &lt; 2\pi\)</span>.</p>
<p>We will evaluate this function at the vertices of a grid like the one shown below (we will see later why we show the six red triangles on this picture):</p>
<p><img src="./figures/OpenglParametricWithNormals-grid-1.png" /></p>
<p>We write a function that evaluates the values of a parametrization at the point of this grid and put them in an array:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">import</span>           <span class="dt">Data.Array</span>      (<span class="dt">Array</span>, (!), array)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Array</span> <span class="kw">as</span> <span class="dt">A</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="ot">frac ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb2-5" title="5">frac p q <span class="ot">=</span> <span class="fu">realToFrac</span> p <span class="op">/</span> <span class="fu">realToFrac</span> q</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="ot">allVertices ::</span> (<span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Point</span>) <span class="ot">-&gt;</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Point</span></a>
<a class="sourceLine" id="cb2-8" title="8">allVertices f (n_u, n_v) <span class="ot">=</span> array ((<span class="dv">0</span>,<span class="dv">0</span>), (n_u<span class="op">-</span><span class="dv">1</span>,n_v<span class="op">-</span><span class="dv">1</span>)) associations</a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-10" title="10">  u_ <span class="ot">=</span> [<span class="dv">2</span><span class="op">*</span><span class="fu">pi</span> <span class="op">*</span> frac i n_u <span class="op">|</span> i <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_u<span class="op">-</span><span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb2-11" title="11">  v_ <span class="ot">=</span> [<span class="dv">2</span><span class="op">*</span><span class="fu">pi</span> <span class="op">*</span> frac i n_v <span class="op">|</span> i <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_v<span class="op">-</span><span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb2-12" title="12">  indices <span class="ot">=</span> [(i,j) <span class="op">|</span> i <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_u<span class="op">-</span><span class="dv">1</span>], j <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_v<span class="op">-</span><span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb2-13" title="13">  g (i,j) <span class="ot">=</span> ((i,j), f (u_ <span class="op">!!</span> i) (v_ <span class="op">!!</span> j))</a>
<a class="sourceLine" id="cb2-14" title="14">  associations <span class="ot">=</span> <span class="fu">map</span> g indices</a></code></pre></div>
<p>These values are the surface vertices. Now, we write a function that approximates the surface normal at vertex <span class="math inline">\((i,j)\)</span>. This normal approximately is the average of the normals of the six triangles incident to the vertex.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">type</span> <span class="dt">Vector</span> <span class="ot">=</span> (<span class="dt">Double</span>, <span class="dt">Double</span>, <span class="dt">Double</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ot">triangleNormal ::</span> (<span class="dt">Point</span>, <span class="dt">Point</span>, <span class="dt">Point</span>) <span class="ot">-&gt;</span> <span class="dt">Vector</span></a>
<a class="sourceLine" id="cb3-4" title="4">triangleNormal ((x1,x2,x3), (y1,y2,y3), (z1,z2,z3)) <span class="ot">=</span> (a<span class="op">/</span>norm, b<span class="op">/</span>norm, c<span class="op">/</span>norm)</a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-6" title="6">    (a, b, c) <span class="ot">=</span> crossProd (z1<span class="op">-</span>x1, z2<span class="op">-</span>x2, z3<span class="op">-</span>x3) (y1<span class="op">-</span>x1, y2<span class="op">-</span>x2, y3<span class="op">-</span>x3) </a>
<a class="sourceLine" id="cb3-7" title="7">    crossProd (a1,a2,a3) (b1,b2,b3) <span class="ot">=</span> (a2<span class="op">*</span>b3<span class="op">-</span>a3<span class="op">*</span>b2, a3<span class="op">*</span>b1<span class="op">-</span>a1<span class="op">*</span>b3, a1<span class="op">*</span>b2<span class="op">-</span>a2<span class="op">*</span>b1)</a>
<a class="sourceLine" id="cb3-8" title="8">    norm <span class="ot">=</span> <span class="fu">sqrt</span>(a<span class="op">*</span>a <span class="op">+</span> b<span class="op">*</span>b <span class="op">+</span> c<span class="op">*</span>c)</a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="ot">averageNormals ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Vector</span></a>
<a class="sourceLine" id="cb3-11" title="11">averageNormals (x1,y1,z1) (x2,y2,z2) (x3,y3,z3) (x4,y4,z4) (x5,y5,z5) (x6,y6,z6) <span class="ot">=</span> </a>
<a class="sourceLine" id="cb3-12" title="12">  ((x1<span class="op">+</span>x2<span class="op">+</span>x3<span class="op">+</span>x4<span class="op">+</span>x5<span class="op">+</span>x6)<span class="op">/</span><span class="dv">6</span>, (y1<span class="op">+</span>y2<span class="op">+</span>y3<span class="op">+</span>y4<span class="op">+</span>y5<span class="op">+</span>y6)<span class="op">/</span><span class="dv">6</span>, (z1<span class="op">+</span>z2<span class="op">+</span>z3<span class="op">+</span>z4<span class="op">+</span>z5<span class="op">+</span>z6)<span class="op">/</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb3-13" title="13"></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="ot">normal_ij ::</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Point</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Vector</span></a>
<a class="sourceLine" id="cb3-15" title="15">normal_ij vertices (i,j) <span class="ot">=</span> averageNormals n1 n2 n3 n4 n5 n6</a>
<a class="sourceLine" id="cb3-16" title="16">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-17" title="17">  ((_,_), (n_u',n_v')) <span class="ot">=</span> A.bounds vertices</a>
<a class="sourceLine" id="cb3-18" title="18">  im1 <span class="ot">=</span> <span class="kw">if</span> i<span class="op">==</span><span class="dv">0</span> <span class="kw">then</span> n_u' <span class="kw">else</span> i<span class="op">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-19" title="19">  ip1 <span class="ot">=</span> <span class="kw">if</span> i<span class="op">==</span>n_u' <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> i<span class="op">+</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-20" title="20">  jm1 <span class="ot">=</span> <span class="kw">if</span> j<span class="op">==</span><span class="dv">0</span> <span class="kw">then</span> n_v' <span class="kw">else</span> j<span class="op">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-21" title="21">  jp1 <span class="ot">=</span> <span class="kw">if</span> j<span class="op">==</span>n_v' <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> j<span class="op">+</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-22" title="22">  n1 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (i,jp1), vertices <span class="op">!</span> (ip1,j))</a>
<a class="sourceLine" id="cb3-23" title="23">  n2 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (ip1,jm1), vertices <span class="op">!</span> (i,jm1))</a>
<a class="sourceLine" id="cb3-24" title="24">  n3 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (im1,j), vertices <span class="op">!</span> (im1,jp1))</a>
<a class="sourceLine" id="cb3-25" title="25">  n4 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (ip1,j), vertices <span class="op">!</span> (ip1,jm1))</a>
<a class="sourceLine" id="cb3-26" title="26">  n5 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (i,jm1), vertices <span class="op">!</span> (im1,j))</a>
<a class="sourceLine" id="cb3-27" title="27">  n6 <span class="ot">=</span> triangleNormal (vertices <span class="op">!</span> (i,j), vertices <span class="op">!</span> (im1,jp1), vertices <span class="op">!</span> (i,jp1))</a></code></pre></div>
<p>Now we write a function that takes the array of surface vertices as input and returns an array containing the surface normals:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="ot">allNormals ::</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Vector</span></a>
<a class="sourceLine" id="cb4-2" title="2">allNormals vertices <span class="ot">=</span> array bounds associations</a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-4" title="4">  bounds <span class="ot">=</span> A.bounds vertices</a>
<a class="sourceLine" id="cb4-5" title="5">  indices <span class="ot">=</span> A.indices vertices  </a>
<a class="sourceLine" id="cb4-6" title="6">  associations <span class="ot">=</span> <span class="fu">map</span> (\(i,j) <span class="ot">-&gt;</span> ((i,j), normal_ij vertices (i,j))) indices</a></code></pre></div>
<p>Let’s say that a surface triangle whose each vertex is attached to the<br />
corresponding surface normal is a n-triangle. To each vertex <span class="math inline">\((i,j)\)</span>, we associate two n-triangles: the lower n-triangle for vertices <span class="math inline">\((i,j)\)</span>-<span class="math inline">\((i+1,j)\)</span>-<span class="math inline">\((i,j+1)\)</span> and the upper n-triangle for vertices <span class="math inline">\((i+1,j+1)\)</span>-<span class="math inline">\((i,j+1)\)</span>-<span class="math inline">\((i+1,j)\)</span>. We write a function that takes as input the two arrays (vertices and normals), an index <span class="math inline">\((i,j)\)</span>, and that returns the two n-triangles:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">import</span> <span class="dt">Graphics.Rendering.OpenGL.GL</span> (<span class="dt">Normal3</span> (..), <span class="dt">Vertex3</span> (..))</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">type</span> <span class="dt">NPoint</span> <span class="ot">=</span> (<span class="dt">Vertex3</span> <span class="dt">Double</span>, <span class="dt">Normal3</span> <span class="dt">Double</span>)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">type</span> <span class="dt">NTriangle</span> <span class="ot">=</span> (<span class="dt">NPoint</span>, <span class="dt">NPoint</span>, <span class="dt">NPoint</span>)</a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="ot">pointToVertex3 ::</span> <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">Vertex3</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb5-7" title="7">pointToVertex3 (x,y,z) <span class="ot">=</span> <span class="dt">Vertex3</span> x y z</a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="ot">vectorToNormal3 ::</span> <span class="dt">Vector</span> <span class="ot">-&gt;</span> <span class="dt">Normal3</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb5-10" title="10">vectorToNormal3 (x,y,z) <span class="ot">=</span> <span class="dt">Normal3</span> x y z</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="ot">triangles_ij ::</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Point</span> <span class="ot">-&gt;</span> <span class="dt">Array</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="dt">Vector</span> </a>
<a class="sourceLine" id="cb5-13" title="13">            <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb5-14" title="14">            <span class="ot">-&gt;</span> (<span class="dt">NTriangle</span>, <span class="dt">NTriangle</span>)</a>
<a class="sourceLine" id="cb5-15" title="15">triangles_ij vertices normals (n_u,n_v) (i,j) <span class="ot">=</span> </a>
<a class="sourceLine" id="cb5-16" title="16">  (((a,na), (b,nb), (c,nc)), ((c,nc), (b,nb), (d,nd)))</a>
<a class="sourceLine" id="cb5-17" title="17">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-18" title="18">  ip1 <span class="ot">=</span> <span class="kw">if</span> i<span class="op">==</span>n_u<span class="op">-</span><span class="dv">1</span> <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> i<span class="op">+</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb5-19" title="19">  jp1 <span class="ot">=</span> <span class="kw">if</span> j<span class="op">==</span>n_v<span class="op">-</span><span class="dv">1</span> <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> j<span class="op">+</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb5-20" title="20">  a <span class="ot">=</span> pointToVertex3 <span class="op">$</span> vertices <span class="op">!</span> (i,j)</a>
<a class="sourceLine" id="cb5-21" title="21">  na <span class="ot">=</span> vectorToNormal3 <span class="op">$</span> normals <span class="op">!</span> (i,j)</a>
<a class="sourceLine" id="cb5-22" title="22">  c <span class="ot">=</span> pointToVertex3 <span class="op">$</span> vertices <span class="op">!</span> (i,jp1)</a>
<a class="sourceLine" id="cb5-23" title="23">  nc <span class="ot">=</span> vectorToNormal3 <span class="op">$</span> normals <span class="op">!</span> (i,jp1)</a>
<a class="sourceLine" id="cb5-24" title="24">  d <span class="ot">=</span> pointToVertex3 <span class="op">$</span> vertices <span class="op">!</span> (ip1,jp1)</a>
<a class="sourceLine" id="cb5-25" title="25">  nd <span class="ot">=</span> vectorToNormal3 <span class="op">$</span> normals <span class="op">!</span> (ip1,jp1)</a>
<a class="sourceLine" id="cb5-26" title="26">  b <span class="ot">=</span> pointToVertex3 <span class="op">$</span> vertices <span class="op">!</span> (ip1,j)</a>
<a class="sourceLine" id="cb5-27" title="27">  nb <span class="ot">=</span> vectorToNormal3 <span class="op">$</span> normals <span class="op">!</span> (ip1,j)</a></code></pre></div>
<p>Finally, we write a function returning the list of all pairs of n-triangles:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="ot">allTriangles ::</span> (<span class="dt">Int</span>,<span class="dt">Int</span>) <span class="ot">-&gt;</span> [(<span class="dt">NTriangle</span>,<span class="dt">NTriangle</span>)]</a>
<a class="sourceLine" id="cb6-2" title="2">allTriangles (n_u,n_v) <span class="ot">=</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="fu">map</span> (triangles_ij vertices normals (n_u,n_v)) indices</a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-5" title="5">  vertices <span class="ot">=</span> allVertices hopf (n_u,n_v)</a>
<a class="sourceLine" id="cb6-6" title="6">  normals <span class="ot">=</span> allNormals vertices</a>
<a class="sourceLine" id="cb6-7" title="7">  indices <span class="ot">=</span> [(i,j) <span class="op">|</span> i <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_u<span class="op">-</span><span class="dv">1</span>], j <span class="ot">&lt;-</span> [<span class="dv">0</span> <span class="op">..</span> n_v<span class="op">-</span><span class="dv">1</span>]]</a></code></pre></div>
<p>Done. It remains to write the OpenGL side:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">import</span> <span class="dt">Data.IORef</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">import</span> <span class="dt">Graphics.Rendering.OpenGL.GL</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">import</span> <span class="dt">Graphics.UI.GLUT</span></a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="ot">hopfTorus ::</span> [(<span class="dt">NTriangle</span>,<span class="dt">NTriangle</span>)]</a>
<a class="sourceLine" id="cb7-6" title="6">hopfTorus <span class="ot">=</span> allTriangles (<span class="dv">400</span>,<span class="dv">400</span>)</a>
<a class="sourceLine" id="cb7-7" title="7"></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="kw">data</span> <span class="dt">Context</span> <span class="ot">=</span> <span class="dt">Context</span></a>
<a class="sourceLine" id="cb7-9" title="9">    {</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="ot">      contextRot1      ::</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span></a>
<a class="sourceLine" id="cb7-11" title="11">    ,<span class="ot"> contextRot2      ::</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span></a>
<a class="sourceLine" id="cb7-12" title="12">    ,<span class="ot"> contextRot3      ::</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span></a>
<a class="sourceLine" id="cb7-13" title="13">    ,<span class="ot"> contextTriangles ::</span> <span class="dt">IORef</span> [(<span class="dt">NTriangle</span>,<span class="dt">NTriangle</span>)]</a>
<a class="sourceLine" id="cb7-14" title="14">    }</a>
<a class="sourceLine" id="cb7-15" title="15"></a>
<a class="sourceLine" id="cb7-16" title="16">white,black,<span class="ot">pink ::</span> <span class="dt">Color4</span> <span class="dt">GLfloat</span></a>
<a class="sourceLine" id="cb7-17" title="17">white      <span class="ot">=</span> <span class="dt">Color4</span>    <span class="dv">1</span>   <span class="dv">1</span>   <span class="dv">1</span>    <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-18" title="18">black      <span class="ot">=</span> <span class="dt">Color4</span>    <span class="dv">0</span>   <span class="dv">0</span>   <span class="dv">0</span>    <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-19" title="19">pink       <span class="ot">=</span> <span class="dt">Color4</span>    <span class="dv">1</span>   <span class="dv">0</span>   <span class="fl">0.5</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-20" title="20"></a>
<a class="sourceLine" id="cb7-21" title="21"><span class="ot">display ::</span> <span class="dt">Context</span> <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">GLdouble</span> <span class="ot">-&gt;</span> <span class="dt">DisplayCallback</span></a>
<a class="sourceLine" id="cb7-22" title="22">display context zoom alpha <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-23" title="23">  clear [<span class="dt">ColorBuffer</span>, <span class="dt">DepthBuffer</span>]</a>
<a class="sourceLine" id="cb7-24" title="24">  r1 <span class="ot">&lt;-</span> get (contextRot1 context)</a>
<a class="sourceLine" id="cb7-25" title="25">  r2 <span class="ot">&lt;-</span> get (contextRot2 context)</a>
<a class="sourceLine" id="cb7-26" title="26">  r3 <span class="ot">&lt;-</span> get (contextRot3 context)</a>
<a class="sourceLine" id="cb7-27" title="27">  ntriangles <span class="ot">&lt;-</span> get (contextTriangles context)</a>
<a class="sourceLine" id="cb7-28" title="28">  <span class="kw">let</span> ntriangles' <span class="ot">=</span> <span class="fu">unzip</span> ntriangles</a>
<a class="sourceLine" id="cb7-29" title="29">      lowerTriangles <span class="ot">=</span> <span class="fu">fst</span> ntriangles'</a>
<a class="sourceLine" id="cb7-30" title="30">      upperTriangles <span class="ot">=</span> <span class="fu">snd</span> ntriangles'</a>
<a class="sourceLine" id="cb7-31" title="31">  z <span class="ot">&lt;-</span> get zoom</a>
<a class="sourceLine" id="cb7-32" title="32">  loadIdentity</a>
<a class="sourceLine" id="cb7-33" title="33">  (_, size) <span class="ot">&lt;-</span> get viewport</a>
<a class="sourceLine" id="cb7-34" title="34">  resize z size</a>
<a class="sourceLine" id="cb7-35" title="35">  rotate r1 <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-36" title="36">  rotate r2 <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-37" title="37">  rotate r3 <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-38" title="38">  renderPrimitive <span class="dt">Triangles</span> <span class="op">$</span> <span class="fu">mapM_</span> drawTriangle lowerTriangles</a>
<a class="sourceLine" id="cb7-39" title="39">  renderPrimitive <span class="dt">Triangles</span> <span class="op">$</span> <span class="fu">mapM_</span> drawTriangle lowerTriangles</a>
<a class="sourceLine" id="cb7-40" title="40">  swapBuffers</a>
<a class="sourceLine" id="cb7-41" title="41">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-42" title="42">    drawTriangle ((v1,n1),(v2,n2),(v3,n3)) <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-43" title="43">      materialDiffuse <span class="dt">Front</span> <span class="op">$=</span> pink</a>
<a class="sourceLine" id="cb7-44" title="44">      normal n1</a>
<a class="sourceLine" id="cb7-45" title="45">      vertex v1</a>
<a class="sourceLine" id="cb7-46" title="46">      normal n2</a>
<a class="sourceLine" id="cb7-47" title="47">      vertex v2</a>
<a class="sourceLine" id="cb7-48" title="48">      normal n3</a>
<a class="sourceLine" id="cb7-49" title="49">      vertex v3</a>
<a class="sourceLine" id="cb7-50" title="50"></a>
<a class="sourceLine" id="cb7-51" title="51"><span class="ot">resize ::</span> <span class="dt">GLdouble</span> <span class="ot">-&gt;</span> <span class="dt">Size</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb7-52" title="52">resize zoom s<span class="op">@</span>(<span class="dt">Size</span> w h) <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-53" title="53">  viewport <span class="op">$=</span> (<span class="dt">Position</span> <span class="dv">0</span> <span class="dv">0</span>, s)</a>
<a class="sourceLine" id="cb7-54" title="54">  matrixMode <span class="op">$=</span> <span class="dt">Projection</span></a>
<a class="sourceLine" id="cb7-55" title="55">  loadIdentity</a>
<a class="sourceLine" id="cb7-56" title="56">  perspective <span class="fl">45.0</span> (<span class="fu">realToFrac</span> w <span class="op">/</span> <span class="fu">realToFrac</span> h) <span class="fl">1.0</span> <span class="fl">100.0</span></a>
<a class="sourceLine" id="cb7-57" title="57">  lookAt (<span class="dt">Vertex3</span> <span class="dv">0</span> <span class="dv">0</span> (<span class="dv">24</span><span class="op">+</span>zoom)) (<span class="dt">Vertex3</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-58" title="58">  matrixMode <span class="op">$=</span> <span class="dt">Modelview</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-59" title="59"></a>
<a class="sourceLine" id="cb7-60" title="60"><span class="ot">keyboard ::</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span> <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span> <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">GLfloat</span> <span class="co">-- rotations</span></a>
<a class="sourceLine" id="cb7-61" title="61">         <span class="ot">-&gt;</span> <span class="dt">IORef</span> <span class="dt">GLdouble</span> <span class="co">-- zoom</span></a>
<a class="sourceLine" id="cb7-62" title="62">         <span class="ot">-&gt;</span> <span class="dt">IORef</span> [(<span class="dt">NTriangle</span>,<span class="dt">NTriangle</span>)]</a>
<a class="sourceLine" id="cb7-63" title="63">         <span class="ot">-&gt;</span> <span class="dt">KeyboardCallback</span></a>
<a class="sourceLine" id="cb7-64" title="64">keyboard rot1 rot2 rot3 zoom triangles c _ <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-65" title="65">  <span class="kw">case</span> c <span class="kw">of</span></a>
<a class="sourceLine" id="cb7-66" title="66">    <span class="ch">'e'</span> <span class="ot">-&gt;</span> rot1 <span class="op">$~!</span> <span class="fu">subtract</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb7-67" title="67">    <span class="ch">'r'</span> <span class="ot">-&gt;</span> rot1 <span class="op">$~!</span> (<span class="op">+</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-68" title="68">    <span class="ch">'t'</span> <span class="ot">-&gt;</span> rot2 <span class="op">$~!</span> <span class="fu">subtract</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb7-69" title="69">    <span class="ch">'y'</span> <span class="ot">-&gt;</span> rot2 <span class="op">$~!</span> (<span class="op">+</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-70" title="70">    <span class="ch">'u'</span> <span class="ot">-&gt;</span> rot3 <span class="op">$~!</span> <span class="fu">subtract</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb7-71" title="71">    <span class="ch">'i'</span> <span class="ot">-&gt;</span> rot3 <span class="op">$~!</span> (<span class="op">+</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-72" title="72">    <span class="ch">'m'</span> <span class="ot">-&gt;</span> zoom <span class="op">$~!</span> (<span class="op">+</span><span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb7-73" title="73">    <span class="ch">'l'</span> <span class="ot">-&gt;</span> zoom <span class="op">$~!</span> <span class="fu">subtract</span> <span class="fl">0.1</span></a>
<a class="sourceLine" id="cb7-74" title="74">    <span class="ch">'q'</span> <span class="ot">-&gt;</span> leaveMainLoop</a>
<a class="sourceLine" id="cb7-75" title="75">    _   <span class="ot">-&gt;</span> <span class="fu">return</span> ()</a>
<a class="sourceLine" id="cb7-76" title="76">  postRedisplay <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-77" title="77"></a>
<a class="sourceLine" id="cb7-78" title="78"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb7-79" title="79">main <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb7-80" title="80">  _ <span class="ot">&lt;-</span> getArgsAndInitialize</a>
<a class="sourceLine" id="cb7-81" title="81">  _ <span class="ot">&lt;-</span> createWindow <span class="st">&quot;Hopf torus&quot;</span></a>
<a class="sourceLine" id="cb7-82" title="82">  windowSize <span class="op">$=</span> <span class="dt">Size</span> <span class="dv">500</span> <span class="dv">500</span></a>
<a class="sourceLine" id="cb7-83" title="83">  initialDisplayMode <span class="op">$=</span> [<span class="dt">RGBAMode</span>, <span class="dt">DoubleBuffered</span>, <span class="dt">WithDepthBuffer</span>]</a>
<a class="sourceLine" id="cb7-84" title="84">  clearColor <span class="op">$=</span> black</a>
<a class="sourceLine" id="cb7-85" title="85">  materialAmbient <span class="dt">Front</span> <span class="op">$=</span> black</a>
<a class="sourceLine" id="cb7-86" title="86">  lighting <span class="op">$=</span> <span class="dt">Enabled</span></a>
<a class="sourceLine" id="cb7-87" title="87">  light (<span class="dt">Light</span> <span class="dv">0</span>) <span class="op">$=</span> <span class="dt">Enabled</span></a>
<a class="sourceLine" id="cb7-88" title="88">  position (<span class="dt">Light</span> <span class="dv">0</span>) <span class="op">$=</span> <span class="dt">Vertex4</span> <span class="dv">0</span> <span class="dv">0</span> (<span class="op">-</span><span class="dv">1000</span>) <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-89" title="89">  ambient (<span class="dt">Light</span> <span class="dv">0</span>) <span class="op">$=</span> white</a>
<a class="sourceLine" id="cb7-90" title="90">  diffuse (<span class="dt">Light</span> <span class="dv">0</span>) <span class="op">$=</span> white</a>
<a class="sourceLine" id="cb7-91" title="91">  specular (<span class="dt">Light</span> <span class="dv">0</span>) <span class="op">$=</span> white</a>
<a class="sourceLine" id="cb7-92" title="92">  depthFunc <span class="op">$=</span> <span class="dt">Just</span> <span class="dt">Less</span></a>
<a class="sourceLine" id="cb7-93" title="93">  shadeModel <span class="op">$=</span> <span class="dt">Smooth</span></a>
<a class="sourceLine" id="cb7-94" title="94">  rot1 <span class="ot">&lt;-</span> newIORef <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb7-95" title="95">  rot2 <span class="ot">&lt;-</span> newIORef <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb7-96" title="96">  rot3 <span class="ot">&lt;-</span> newIORef <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb7-97" title="97">  zoom <span class="ot">&lt;-</span> newIORef <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb7-98" title="98">  nlobes' <span class="ot">&lt;-</span> newIORef nlobes</a>
<a class="sourceLine" id="cb7-99" title="99">  hopfTorus' <span class="ot">&lt;-</span> newIORef hopfTorus</a>
<a class="sourceLine" id="cb7-100" title="100">  displayCallback <span class="op">$=</span> display <span class="dt">Context</span> {contextRot1 <span class="ot">=</span> rot1,</a>
<a class="sourceLine" id="cb7-101" title="101">                                      contextRot2 <span class="ot">=</span> rot2,</a>
<a class="sourceLine" id="cb7-102" title="102">                                      contextRot3 <span class="ot">=</span> rot3,</a>
<a class="sourceLine" id="cb7-103" title="103">                                      contextTriangles <span class="ot">=</span> hopfTorus'}</a>
<a class="sourceLine" id="cb7-104" title="104">                             zoom </a>
<a class="sourceLine" id="cb7-105" title="105">  reshapeCallback <span class="op">$=</span> <span class="dt">Just</span> (resize <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-106" title="106">  keyboardCallback <span class="op">$=</span> <span class="dt">Just</span> (keyboard rot1 rot2 rot3 zoom hopfTorus')</a>
<a class="sourceLine" id="cb7-107" title="107">  idleCallback <span class="op">$=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb7-108" title="108">  <span class="fu">putStrLn</span> <span class="st">&quot;*** Hopf torus ***\n\</span></a>
<a class="sourceLine" id="cb7-109" title="109"><span class="st">        \    To quit, press q.\n\</span></a>
<a class="sourceLine" id="cb7-110" title="110"><span class="st">        \    Scene rotation: e, r, t, y, u, i\n\</span></a>
<a class="sourceLine" id="cb7-111" title="111"><span class="st">        \    Zoom: l, m\n\</span></a>
<a class="sourceLine" id="cb7-112" title="112"><span class="st">        \&quot;</span></a>
<a class="sourceLine" id="cb7-113" title="113"><span class="st">  mainLoop</span></a></code></pre></div>
<p>And this is the result:</p>
<p><img src="./figures/OpenglParametricWithNormals-Result.png" /></p>
<p>The full code is available in <a href="https://github.com/stla/opengl-HopfTorus">this Github repo</a>.</p>

        </div>


        <div id="footer">
          Site proudly generated by
          <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

      </div>

    </div>

    <div class="row">
      <div class="col-sm-12">
        <div id="disqus_thread"></div>
        <div class="pagination">
          <ul>
            <li>
              <a href="http://laustep.github.io/stlahblog/">« Back Home</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    
  </div>

</body>

<script src="../libraries/bootstrap/bootstrap.min.js"></script>
<script>
  var disqus_developer = 1;
  var disqus_shortname = 'stlapblog';
  // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] ||
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<!-- MathJax: Fall back to local if CDN offline but local image fonts are not supported (saves >100MB) -->
<script type="text/x-mathjax-config" src="../libraries/mathjax/config/TeX-MML-AM_CHTML.js"></script>
<!-- <script>
  window.MathJax || document.write('<script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS":{imageFont:null}});<\/script><script src="../libraries/mathjax/MathJax.js"><\/script>');
</script> -->

  <!-- Google Prettify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
  <script src="../libraries/highlighters/prettify/js/lang-r.js"></script>
  <script>
    var pres = document.getElementsByTagName("pre");
    for (var i = 0; i < pres.length; ++i) {
      
        pres[i].className = pres[i].className + " prettyprint linenums";
      
    }
    prettyPrint();
  </script> 


</html>