<html>

<head>
    <title>da Vinci's 72-sided sphere</title>
    <style>
        canvas {
            width: 100%;
            height: 100%
        }
    </style>
</head>

<body>
    <script src="../libraries/three.min.js"></script>
    <script src="../libraries/jquery.min.js"></script>
    <script src="../libraries/dat.gui.min.js"></script>

    <script> // vertices and edges  --------------------------------------------
        var vertices = [
          [1.61352, -0.43234, 1.1862],
          [1.18118, -1.18118, 1.1862],
          [0.43234, -1.61352, 1.1862],
          [-0.43234, -1.61352, 1.1862],
          [-1.18118, -1.18118, 1.1862],
          [-1.61352, -0.43234, 1.1862],
          [-1.61352, 0.43234, 1.1862],
          [-1.18118, 1.18118, 1.1862],
          [-0.43234, 1.61352, 1.1862],
          [0.43234, 1.61352, 1.1862],
          [1.18118, 1.18118, 1.1862],
          [1.61352, 0.43234, 1.1862],
          [1.61352, -0.43234, -1.1862],
          [1.61352, 0.43234, -1.1862],
          [1.18118, 1.18118, -1.1862],
          [0.43234, 1.61352, -1.1862],
          [-0.43234, 1.61352, -1.1862],
          [-1.18118, 1.18118, -1.1862],
          [-1.61352, 0.43234, -1.1862],
          [-1.61352, -0.43234, -1.1862],
          [-1.18118, -1.18118, -1.1862],
          [-0.43234, -1.61352, -1.1862],
          [0.43234, -1.61352, -1.1862],
          [1.18118, -1.18118, -1.1862],
          [2.0102, 0.53863, 0],
          [1.47157, 1.47157, 0],
          [0.53863, 2.0102, 0],
          [-0.53863, 2.0102, 0],
          [-1.47157, 1.47157, 0],
          [-2.0102, 0.53863, 0],
          [-2.0102, -0.53863, 0],
          [-1.47157, -1.47157, 0],
          [-0.53863, -2.0102, 0],
          [0.53863, -2.0102, 0],
          [1.47157, -1.47157, 0],
          [2.0102, -0.53863, 0],
          [0.89068, 0.23866, 1.77777],
          [0.89068, -0.23866, 1.77777],
          [0.65202, -0.65202, 1.77777],
          [0.23866, -0.89068, 1.77777],
          [-0.23866, -0.89068, 1.77777],
          [-0.65202, -0.65202, 1.77777],
          [-0.89068, -0.23866, 1.77777],
          [-0.89068, 0.23866, 1.77777],
          [-0.65202, 0.65202, 1.77777],
          [-0.23866, 0.89068, 1.77777],
          [0.23866, 0.89068, 1.77777],
          [0.65202, 0.65202, 1.77777],
          [0.65202, -0.65202, -1.77777],
          [0.89068, -0.23866, -1.77777],
          [0.89068, 0.23866, -1.77777],
          [0.65202, 0.65202, -1.77777],
          [0.23866, 0.89068, -1.77777],
          [-0.23866, 0.89068, -1.77777],
          [-0.65202, 0.65202, -1.77777],
          [-0.89068, 0.23866, -1.77777],
          [-0.89068, -0.23866, -1.77777],
          [-0.65202, -0.65202, -1.77777],
          [-0.23866, -0.89068, -1.77777],
          [0.23866, -0.89068, -1.77777],
          [0, 0, 2.04922],
          [0, 0, -2.04922]
        ];
        var edges = [
          [0,11],
          [11,24],
          [24,35],
          [10,25],
          [9,26],
          [8,27],
          [7,28],
          [6,29],
          [5,30],
          [4,31],
          [3,32],
          [2,33],
          [1,34],
          [0,35],
          [12,35],
          [13,24],
          [24,25],
          [14,25],
          [25,26],
          [15,26],
          [26,27],
          [16,27],
          [27,28],
          [17,28],
          [28,29],
          [18,29],
          [29,30],
          [19,30],
          [30,31],
          [20,31],
          [31,32],
          [21,32],
          [32,33],
          [22,33],
          [33,34],
          [12,23],
          [23,34],
          [34,35],
          [0,37],
          [0,1],
          [1,38],
          [1,2],
          [2,39],
          [2,3],
          [3,40],
          [3,4],
          [4,41],
          [4,5],
          [5,42],
          [5,6],
          [6,43],
          [6,7],
          [7,44],
          [7,8],
          [8,45],
          [8,9],
          [9,46],
          [9,10],
          [10,47],
          [10,11],
          [11,36],
          [36,47],
          [12,49],
          [12,13],
          [13,50],
          [13,14],
          [14,51],
          [14,15],
          [15,52],
          [15,16],
          [16,53],
          [16,17],
          [17,54],
          [17,18],
          [18,55],
          [18,19],
          [19,56],
          [19,20],
          [20,57],
          [20,21],
          [21,58],
          [21,22],
          [22,59],
          [22,23],
          [23,48],
          [48,59],
          [36,60],
          [36,37],
          [37,60],
          [37,38],
          [38,60],
          [38,39],
          [39,60],
          [39,40],
          [40,60],
          [40,41],
          [41,60],
          [41,42],
          [42,60],
          [42,43],
          [43,60],
          [43,44],
          [44,60],
          [44,45],
          [45,60],
          [45,46],
          [46,60],
          [46,47],
          [47,60],
          [48,61],
          [48,49],
          [49,61],
          [49,50],
          [50,61],
          [50,51],
          [51,61],
          [51,52],
          [52,61],
          [52,53],
          [53,61],
          [53,54],
          [54,61],
          [54,55],
          [55,61],
          [55,56],
          [56,61],
          [56,57],
          [57,61],
          [57,58],
          [58,61],
          [58,59],
          [59,61]
        ];
        var facets = [
          [0,11,24,35],
          [10,25,24,11],
          [9,26,25,10],
          [8,27,26,9],
          [7,28,27,8],
          [6,29,28,7],
          [5,30,29,6],
          [4,31,30,5],
          [3,32,31,4],
          [2,33,32,3],
          [1,34,33,2],
          [0,35,34,1],
          [12,35,24,13],
          [13,24,25,14],
          [14,25,26,15],
          [15,26,27,16],
          [16,27,28,17],
          [17,28,29,18],
          [18,29,30,19],
          [19,30,31,20],
          [20,31,32,21],
          [21,32,33,22],
          [22,33,34,23],
          [12,23,34,35],
          [0,37,36,11],
          [0,1,38,37],
          [1,2,39,38],
          [2,3,40,39],
          [3,4,41,40],
          [4,5,42,41],
          [5,6,43,42],
          [6,7,44,43],
          [7,8,45,44],
          [8,9,46,45],
          [9,10,47,46],
          [10,11,36,47],
          [12,49,48,23],
          [12,13,50,49],
          [13,14,51,50],
          [14,15,52,51],
          [15,16,53,52],
          [16,17,54,53],
          [17,18,55,54],
          [18,19,56,55],
          [19,20,57,56],
          [20,21,58,57],
          [21,22,59,58],
          [22,23,48,59],
          [36,60,47],
          [37,60,36],
          [38,60,37],
          [39,60,38],
          [40,60,39],
          [41,60,40],
          [42,60,41],
          [43,60,42],
          [44,60,43],
          [45,60,44],
          [46,60,45],
          [47,60,46],
          [48,61,59],
          [49,61,48],
          [50,61,49],
          [51,61,50],
          [52,61,51],
          [53,61,52],
          [54,61,53],
          [55,61,54],
          [56,61,55],
          [57,61,56],
          [58,61,57],
          [59,61,58]
        ];
    </script>

    <script> // Cone mesh ------------------------------------------------------
      // basic cone mesh -------------------------------------------------------
      function Cmesh0(h, R, r, nstacks, nslices, material) {
        if(r>R){
          throw new Error("Ooops !");
        }
        var ratio = r / R;
        var k = (ratio - 1) / h;
        // grid ----------------------------------------------------------------
        nstacks = nstacks + 1;
        var u_ = new Array(nstacks);
        for (var i = 0; i < nstacks; i++) {
          u_[i] = h * i / (nstacks - 1);
        }
        var v_ = new Array(nslices);
        for (var i = 0; i < nslices; i++) {
          v_[i] = 2 * Math.PI * i / nslices;
        }
        // vertices & normals --------------------------------------------------
        var vertices = new Array(nstacks * nslices);
        var normals = new Array(nstacks * nslices);
        for (var i = 0; i < nstacks; i++) {
          var g = 1 + k * u_[i];
          for (var j = 0; j < nslices; j++) {
            var cosv = R * Math.cos(v_[j]);
            var sinv = R * Math.sin(v_[j]);
            var v = new THREE.Vector3(
              g * cosv,
              g * sinv,
              u_[i]
            );
            vertices[i * nslices + j] = v;
            var t1 = new THREE.Vector3(
              k * cosv,
              k * sinv,
              1
            );
            var t2 = new THREE.Vector3(
              -v.y, v.x, 0
            )
            normals[i * nslices + j] = t1.cross(t2).normalize().negate();
          }
        }
        // mesh ----------------------------------------------------------------
        var geom = new THREE.Geometry();
        for (var i = 0; i < (nstacks - 1); i++) {
          for (var j = 0; j < nslices; j++) {
            var jp1 = j == nslices - 1 ? 0 : j + 1;
            geom.vertices.push(vertices[i * nslices + j]);
            geom.vertices.push(vertices[i * nslices + jp1]);
            geom.vertices.push(vertices[(i + 1) * nslices + j]);
            geom.faces.push(new THREE.Face3(
              6 * (i * nslices + j),
              6 * (i * nslices + j) + 1,
              6 * (i * nslices + j) + 2,
              [
                normals[i * nslices + j],
                normals[i * nslices + jp1],
                normals[(i + 1) * nslices + j]
              ]
            ));
            geom.vertices.push(vertices[(i + 1) * nslices + j]);
            geom.vertices.push(vertices[i * nslices + jp1]);
            geom.vertices.push(vertices[(i + 1) * nslices + jp1]);
            geom.faces.push(new THREE.Face3(
              6 * (i * nslices + j) + 3,
              6 * (i * nslices + j) + 4,
              6 * (i * nslices + j) + 5,
              [
                normals[(i + 1) * nslices + j],
                normals[i * nslices + jp1],
                normals[(i + 1) * nslices + jp1]
              ]
            ));
          }
        }
        var bufGeom = new THREE.BufferGeometry().fromGeometry(geom);
        var conemesh = new THREE.Mesh(bufGeom, material);
        return conemesh;
      }
      // general cone mesh -----------------------------------------------------
      function ConeMesh(cr1, r1, cr2, r2, nstacks, nslices, material) {
        if (r2 > r1) {
          return ConeMesh(cr2, r2, cr1, r1, nstacks, nslices, material);
        }
        var w0 = cr2.clone().sub(cr1);
        var conemesh0 = Cmesh0(w0.length(), r1, r2, nstacks, nslices, material);
        var w = w0.normalize();
        var wx = w.x; var wy = w.y;
        var s = Math.sqrt(wx * wx + wy * wy);
        if (s == 0) {
          console.log("s=0");
          var coef = w.z > 0 ? 1 : -1;
          var m = new THREE.Matrix4().set(
            1, 0, 0, cr1.x,
            0, coef, 0, cr1.y,
            0, 0, coef, cr1.z,
            0, 0, 0, 1
          )
          conemesh0.matrix = m;
          conemesh0.matrixAutoUpdate = false;
          return conemesh0;
        }
        var u = new THREE.Vector3(wy / s, -wx / s, 0);
        var v = w.clone().cross(u);
        var m = new THREE.Matrix4().set(
          u.x, v.x, w.x, cr1.x,
          u.y, v.y, w.y, cr1.y,
          u.z, v.z, w.z, cr1.z,
          0, 0, 0, 1
        )
        conemesh0.matrix = m;
        conemesh0.matrixAutoUpdate = false;
        return conemesh0;
      }
    </script>

    <script> // dat.gui controls -----------------------------------------------
        var z0 = 4;
        var dgcontrols = new function () {
            this.rotationSpeed = 0.001;
            this.cameraz = z0;
        }
        var gui = new dat.GUI({ autoplace: false, width: 300 });
        gui.add(dgcontrols, 'cameraz').min(1).max(10).step(0.1)
          .name("Camera position");
        gui.add(dgcontrols, 'rotationSpeed').min(0).max(0.005)
          .name("Rotation speed");
    </script>

    <script> // three.js scene -------------------------------------------------
        var scene = new THREE.Scene();
        var aspect = window.innerWidth / window.innerHeight;
        var camera = new THREE.PerspectiveCamera(75, aspect, 1, 10000);
        camera.position.z = z0;
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        var object = new THREE.Object3D();
        var ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
        scene.add(ambientLight);
        var pointLight = new THREE.PointLight(0xffffff, 0.8);
        camera.add(pointLight);
        scene.add(camera);
        var map_gold = new THREE.TextureLoader().load('textures/gold.png');
        var material_gold = new THREE.MeshPhongMaterial({ map: map_gold });


        for(var i=0; i<edges.length; i++){
          var edge = edges[i];
          var cr1 = new THREE.Vector3().fromArray(vertices[edge[0]]);
          var cr2 = new THREE.Vector3().fromArray(vertices[edge[1]]);
          var conemesh = ConeMesh(cr1, 0.04, cr2, 0.04, 3, 30, material_gold);
          object.add(conemesh);
        }
        var geoSphere = new THREE.SphereBufferGeometry(0.05, 16, 16);
        for(var i=0; i<vertices.length; i++){
          var sphere = new THREE.Mesh(geoSphere, material_gold);
          sphere.position.set(vertices[i][0],vertices[i][1],vertices[i][2]);
          object.add(sphere);
        }
        var faceIndex = 0;
        var geoms = new Array(72);
        var colors = [
          0xa3b691, 0x556adb, 0x5eede9, 0x4ae54b,
          0xee8ae9, 0xd8599e, 0xe6b434, 0x90ef98,
          0xa294e7, 0x5a82e0, 0x8b8f41, 0xcec1e9,
          0x5feecb, 0x55afe9, 0xb89784, 0xd6e7ed,
          0x5d54e4, 0x8a5d4c, 0xa74ce7, 0xa9edce,
          0xdbf399, 0x7f9098, 0x9ef03b, 0x91ee6f,
          0xeb40d9, 0xd1c23c, 0xa5d2ec, 0xf5dc8d,
          0x48e17b, 0x61b8b1, 0x9f7af0, 0x65bd93,
          0xe09fe1, 0x92c049, 0x5ba4c2, 0xc9bf67,
          0xefd9ee, 0xe6386b, 0x4f9245, 0xdbb1bc,
          0xaeb3c8, 0xf19fae, 0xee55c1, 0xe9b6e1,
          0x5ccee6, 0x7a5599, 0xe5ec6c, 0xe1f1de,
          0xe3ab62, 0x7240b6, 0xe0ba90, 0xe2759d,
          0xe85334, 0x5492e2, 0xe1ebb9, 0xdc8660,
          0xc47edc, 0xc5e43d, 0x5c75a4, 0x5ae5a8,
          0xabc2bb, 0xa7eaeb, 0xcf61de, 0xb6e4a2,
          0xefe933, 0x672be8, 0xdf7e7e, 0xefd4c6,
          0xd232e8, 0xaaabe4, 0xf38223, 0xa47a9e
        ];
        for(var i=0; i<72; i++){
          geoms[i] = new THREE.Geometry();
          var facet = facets[i];
          if(facet.length == 3){
            geoms[i].vertices.push(
              new THREE.Vector3().fromArray(vertices[facet[0]]),
              new THREE.Vector3().fromArray(vertices[facet[2]]),
              new THREE.Vector3().fromArray(vertices[facet[1]])
            );
            geoms[i].faces.push(new THREE.Face3(0, 1, 2));
          }
          if(facet.length == 4){
            geoms[i].vertices.push(
              new THREE.Vector3().fromArray(vertices[facet[0]]),
              new THREE.Vector3().fromArray(vertices[facet[2]]),
              new THREE.Vector3().fromArray(vertices[facet[1]])
            );
            geoms[i].faces.push(new THREE.Face3(0, 1, 2));
            geoms[i].vertices.push(
              new THREE.Vector3().fromArray(vertices[facet[0]]),
              new THREE.Vector3().fromArray(vertices[facet[3]]),
              new THREE.Vector3().fromArray(vertices[facet[2]])
            );
            geoms[i].faces.push(new THREE.Face3(3, 4, 5));
          }
          var material = new THREE.MeshBasicMaterial({
            color: colors[i],
            transparent: true,
            opacity: 0.3
          });
          var facetMesh = new THREE.Mesh(geoms[i], material);
          object.add(facetMesh);
        }

        scene.add(object);

        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
        })();

        function render() {
            renderer.render(scene, camera);
            object.rotation.x += dgcontrols.rotationSpeed;
            object.rotation.y += dgcontrols.rotationSpeed;
            camera.position.z = dgcontrols.cameraz;
            requestAnimFrame(render);
        }
    </script>

    <script> // dragging -------------------------------------------------------
        var isDragging = false;
        var previousMousePosition = { x: 0, y: 0 };

        $(renderer.domElement).on('mousedown', function (e) {
            isDragging = true;
        }).on('mousemove', function (e) {
            var deltaMove = {
                x: e.offsetX - previousMousePosition.x,
                y: e.offsetY - previousMousePosition.y
            };
            if (isDragging) {
                var deltaRotationQuaternion = new THREE.Quaternion()
                    .setFromEuler(new THREE.Euler(
                        Math.PI / 180 * (deltaMove.y * .5),
                        Math.PI / 180 * (deltaMove.x * .5),
                        0,
                        'XYZ'
                    ));
                object.quaternion.multiplyQuaternions(deltaRotationQuaternion,
                    object.quaternion);
            }
            previousMousePosition = {
                x: e.offsetX,
                y: e.offsetY
            };
        });

        $(document).on('mouseup', function (e) {
            isDragging = false;
        });
    </script>

    <script> // render ---------------------------------------------------------
        render();
    </script>

</body>

</html>
