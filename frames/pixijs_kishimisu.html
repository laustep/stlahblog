<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../libraries/hamster.min.js"></script>
  <title>Kishimisu</title>
  <style>
    html, body { 
      margin: 0; 
    }
    canvas {
      display: block;
    }
  </style>
</head>
<script src="../libraries/pixi.min.js"></script>

<body>

  <script type="text/javascript">
    let type = "WebGL";
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas";
    }
    PIXI.utils.sayHello(type);
  </script>

  <div id="container"></div>

  <script id="fragmentShader" type="x-shader/x-fragment">
    precision highp float;
    uniform vec2 iResolution;
    uniform float iGlobalTime;
    uniform float iTime;
    uniform float s;
    uniform vec2 mouse;
    uniform bool click;

    // map function: map(x, a, b, c, d) sends (a,b) to (b,c)
    float lerp(float t, float a, float b){
      return a + t*(b-a);
    }
    float norm(float t, float a, float b){
      return (t-a)/(b-a);
    }
    float map(float t, float e1, float s1, float e2, float s2){
      return lerp(norm(t, e1, s1), e2, s2);
    }

    // MÃ¶bius transformation
    float pi = 3.1415926535897932384626433832795;
    vec2 product(vec2 a, vec2 b){
      return vec2(a.x*b.x-a.y*b.y, a.x*b.y+a.y*b.x);
    }
    vec2 inverse(vec2 b){
      return vec2(b.x, -b.y) / (b.x*b.x+b.y*b.y);
    }
    vec2 divide(vec2 a, vec2 b){
      return product(a, inverse(b));
    }
    vec2 conjugate(vec2 a){
      return vec2(a.x, -a.y);
    }
    vec2 mobius(vec2 z, vec2 gamma, float t){
      float g2 = gamma.x*gamma.x + gamma.y*gamma.y;
      float h = sqrt(1.0 - g2);
      vec2 d2 = pow(h, t) * vec2(cos(t*pi/2.0), sin(t*pi/2.0));
      vec2 d1 = conjugate(d2);
      vec2 a = vec2(d1.x, -d1.y/h);
      vec2 b = d2.y * gamma / h;
      vec2 c = conjugate(b);
      vec2 d = conjugate(a);
      return divide(product(a, z) + b, product(c, z) + d);
    }



    // https://iquilezles.org/articles/palettes/
    vec3 palette( float t ) {
        vec3 a = vec3(0.5, 0.5, 0.5);
        vec3 b = vec3(0.5, 0.5, 0.5);
        vec3 c = vec3(1.0, 1.0, 1.0);
        vec3 d = vec3(0.263,0.416,0.557);

        return a + b*cos( 6.28318*(c*t+d) );
    }


    void main( void ) {
      vec2 uv = (gl_FragCoord.xy * 2.0 - iResolution.xy) / iResolution.y;
      float t = 1.0 + sin(iGlobalTime); 
      uv = mobius(uv, vec2(0.1,0.2), t+s);
      vec2 uv0 = uv;
      vec3 finalColor = vec3(0.0);
      
      for (float i = 0.0; i < 4.0; i++) {
          uv = fract(uv * 1.5) - 0.5;

          float d = length(uv) * exp(-length(uv0));

          vec3 col = palette(length(uv0) + i*.4 + iTime*.4);

          d = sin(d*8. + iTime)/8.;
          d = abs(d);

          d = pow(0.01 / d, 1.2);

          finalColor += col * d;
      }
          
      gl_FragColor = vec4(finalColor, 1.0);
    }

  </script>

  <script>
    var app = new PIXI.Application({ width: window.innerWidth, height: window.innerHeight });
    app.resizeTo = window;

    let fragmentShader = document.getElementById('fragmentShader').textContent;

    let filter = new PIXI.Filter(null, fragmentShader);
    filter.uniforms.iResolution = {x: app.screen.width, y: app.screen.height};
    filter.uniforms.iTime = 0;
    filter.uniforms.mouse = {x: app.screen.width/2, y: app.screen.height/2};
    filter.uniforms.s = 1;
    //filter.uniforms.iGlobalTime = 0;
    filter.uniforms.click = false;

    document.onclick = function(evt){
      filter.uniforms.s /= 1.01;
      //filter.uniforms.iTime = filter.uniforms.iGlobalTime;
    };

    document.onmousemove = function(evt){
      filter.uniforms.mouse = {x: evt.clientX, y: evt.clientY};
    };

    let factor0 = 1.001;
    let hamster = Hamster(document.body);
    hamster.wheel(function (event, delta, deltaX, deltaY) {
      let factor = Math.max(0.1, Math.pow(factor0, deltaY));
      filter.uniforms.s /= factor;
    });

    let container = new PIXI.Container();
    container.filterArea = app.screen;
    container.filters = [filter];

    app.stage.addChild(container);
    document.getElementById('container').appendChild(app.view);

    function onresize(event){
      if(app.resize)
        app.resize();
      container.filterArea = app.screen;
      filter.uniforms.iResolution = {x: app.screen.width, y: app.screen.height};
    }
    window.addEventListener('resize', onresize, false);

    let startTime = Date.now();
    app.ticker.add(function (delta) {
      var currentTime = Date.now();
      filter.uniforms.iGlobalTime = (currentTime - startTime) * 0.000025;
    });

  </script>
</body>

</html>
